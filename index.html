// Navigation component for T&J Field Services
const Navigation = {
    items: [
        { id: 'dashboard', label: 'Dashboard', icon: 'home' },
        { id: 'estimates', label: 'Estimates', icon: 'calculator' },
        { id: 'customers', label: 'Customers', icon: 'users' },
        { id: 'projects', label: 'Projects', icon: 'briefcase' },
        { id: 'inventory', label: 'Inventory', icon: 'package' },
        { id: 'schedule', label: 'Schedule', icon: 'calendar' },
        { id: 'reports', label: 'Reports', icon: 'bar-chart' }
    ],
    
    render() {
        const navElement = document.getElementById('navigation');
        navElement.innerHTML = `
            <nav class="bg-white shadow-md">
                <div class="container mx-auto px-4">
                    <div class="flex space-x-8 overflow-x-auto">
                        ${this.items.map(item => `
                            <button 
                                onclick="navigateTo('${item.id}')" 
                                class="nav-link px-4 py-3 text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 whitespace-nowrap"
                                data-page="${item.id}"
                            >
                                <i data-lucide="${item.icon}" class="inline w-4 h-4 mr-2"></i>
                                ${item.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </nav>
        `;
    },
    
    setActive(pageId) {
        // Remove active class from all nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Add active class to current page
        const activeLink = document.querySelector(`[data-page="${pageId}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }// Dashboard page for T&J Field Services
const Dashboard = {
    render() {
        const content = document.getElementById('content');
        content.innerHTML = `
            <div class="fade-in">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Business Dashboard</h2>
                
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    ${this.renderMetricCard('estimates', 'Total Estimates', 'file-text', 'blue')}
                    ${this.renderMetricCard('customers', 'Active Customers', 'users', 'green')}
                    ${this.renderMetricCard('projects', 'Active Projects', 'briefcase', 'orange')}
                    ${this.renderMetricCard('revenue', 'Monthly Revenue', 'dollar-sign', 'purple')}
                </div>

                <!-- Quick Actions -->
                ${this.renderQuickActions()}

                <!-- Recent Activity & Tasks -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    ${this.renderRecentActivity()}
                    ${this.renderUpcomingTasks()}
                </div>

                <!-- Quick Stats -->
                ${this.renderQuickStats()}
            </div>
        `;
        
        this.updateMetrics();
        this.loadRecentActivity();
        this.loadUpcomingTasks();
    },
    
    renderMetricCard(type, title, icon, color) {
        return `
            <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <i data-lucide="${icon}" class="w-8 h-8 text-${color}-600 mr-3"></i>
                    <div>
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <p class="text-2xl font-bold text-${color}-600" id="${type}Count">0</p>
                        <p class="text-sm text-gray-500" id="${type}Detail">Loading...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    renderQuickActions() {
        const actions = [
            { id: 'estimates', title: 'New Estimate', subtitle: 'Create project estimate', icon: 'calculator', color: 'blue' },
            { id: 'customers', title: 'Add Customer', subtitle: 'New customer record', icon: 'user-plus', color: 'green' },
            { id: 'projects', title: 'New Project', subtitle: 'Start new project', icon: 'plus-circle', color: 'orange' },
            { id: 'schedule', title: 'Schedule Job', subtitle: 'Book appointment', icon: 'calendar-plus', color: 'purple' }
        ];
        
        return `
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    ${actions.map(action => `
                        <button onclick="navigateTo('${action.id}')" class="bg-${action.color}-600 text-white p-4 rounded-lg hover:bg-${action.color}-700 transition-colors template-btn">
                            <i data-lucide="${action.icon}" class="w-6 h-6 mx-auto mb-2"></i>
                            <div class="font-semibold">${action.title}</div>
                            <div class="text-sm opacity-80">${action.subtitle}</div>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    },
    
    renderRecentActivity() {
        return `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Recent Activity</h3>
                    <button onclick="Dashboard.refreshActivity()" class="text-blue-600 hover:text-blue-800">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="recentActivity" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="activity" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    renderUpcomingTasks() {
        return `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Upcoming Tasks</h3>
                    <button onclick="Dashboard.addQuickTask()" class="text-blue-600 hover:text-blue-800">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="upcomingTasks" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="check-square" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Loading tasks...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    renderQuickStats() {
        return `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="avgEstimate">$0</div>
                    <div class="text-sm text-blue-800">Avg Estimate</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="conversionRate">0%</div>
                    <div class="text-sm text-green-800">Conversion Rate</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-orange-600" id="avgDays">0</div>
                    <div class="text-sm text-orange-800">Avg Project Days</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600">98%</div>
                    <div class="text-sm text-purple-800">Customer Rating</div>
                </div>
            </div>
        `;
    },
    
    updateMetrics() {
        // Update estimates
        const estimatesCount = document.getElementById('estimatesCount');
        const estimatesDetail = document.getElementById('estimatesDetail');
        if (estimatesCount) {
            estimatesCount.textContent = Data.estimates.length;
            const totalValue = Data.estimates.reduce((sum, est) => sum + (parseFloat(est.total) || 0), 0);
            estimatesDetail.textContent = Data.formatCurrency(totalValue) + ' total value';
        }
        
        // Update customers
        const customersCount = document.getElementById('customersCount');
        const customersDetail = document.getElementById('customersDetail');
        if (customersCount) {
            customersCount.textContent = Data.customers.length;
            customersDetail.textContent = 'Active customers';
        }
        
        // Update projects
        const projectsCount = document.getElementById('projectsCount');
        const projectsDetail = document.getElementById('projectsDetail');
        if (projectsCount) {
            const activeProjects = Data.projects.filter(p => p.status === 'in-progress');
            projectsCount.textContent = activeProjects.length;
            projectsDetail.textContent = 'In progress';
        }
        
        // Update revenue
        const revenueCount = document.getElementById('revenueCount');
        const revenueDetail = document.getElementById('revenueDetail');
        if (revenueCount) {
            const completedProjects = Data.projects.filter(p => p.status === 'completed');
            const revenue = completedProjects.reduce((sum, proj) => sum + (parseFloat(proj.value) || 0), 0);
            revenueCount.textContent = Data.formatCurrency(revenue);
            revenueDetail.textContent = 'Total completed';
        }
        
        // Update quick stats
        this.updateQuickStats();
    },
    
    updateQuickStats() {
        // Average estimate
        const avgEstimate = document.getElementById('avgEstimate');
        if (avgEstimate && Data.estimates.length > 0) {
            const avg = Data.estimates.reduce((sum, est) => sum + (parseFloat(est.total) || 0), 0) / Data.estimates.length;
            avgEstimate.textContent = Data.formatCurrency(avg);
        }
        
        // Conversion rate
        const conversionRate = document.getElementById('conversionRate');
        if (conversionRate && Data.estimates.length > 0) {
            const approved = Data.estimates.filter(est => est.status === 'approved').length;
            const rate = (approved / Data.estimates.length * 100).toFixed(1);
            conversionRate.textContent = rate + '%';
        }
    },
    
    loadRecentActivity() {
        const container = document.getElementById('recentActivity');
        if (!container) return;
        
        const activities = [];
        
        // Recent estimates
        Data.estimates.slice(-3).forEach(est => {
            activities.push({
                title: `New estimate for ${est.customerName}`,
                subtitle: Data.formatCurrency(est.total),
                time: est.dateCreated,
                icon: 'calculator',
                color: 'blue'
            });
        });
        
        // Recent customers
        Data.customers.slice(-2).forEach(customer => {
            activities.push({
                title: `New customer: ${customer.name}`,
                subtitle: customer.phone,
                time: customer.dateAdded,
                icon: 'user-plus',
                color: 'green'
            });
        });
        
        activities.sort((a, b) => new Date(b.time) - new Date(a.time));
        
        if (activities.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="activity" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No recent activity</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = activities.slice(0, 5).map(activity => `
            <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition-colors">
                <div class="w-8 h-8 bg-${activity.color}-100 rounded-full flex items-center justify-center mr-3">
                    <i data-lucide="${activity.icon}" class="w-4 h-4 text-${activity.color}-600"></i>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">${activity.title}</p>
                    <p class="text-xs text-gray-500">${activity.subtitle}</p>
                </div>
                <div class="text-xs text-gray-400">
                    ${this.getTimeAgo(activity.time)}
                </div>
            </div>
        `).join('');
    },
    
    loadUpcomingTasks() {
        const container = document.getElementById('upcomingTasks');
        if (!container) return;
        
        const tasks = Data.load('tasks') || [];
        
        if (tasks.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="check-square" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No upcoming tasks</p>
                    <button onclick="Dashboard.addQuickTask()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">
                        Add a task
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = tasks.slice(0, 5).map(task => `
            <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition-colors">
                <input type="checkbox" ${task.completed ? 'checked' : ''} 
                       onchange="Dashboard.toggleTask('${task.id}')" 
                       class="mr-3">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900 ${task.completed ? 'line-through' : ''}">${task.title}</p>
                    <p class="text-xs text-gray-500">${Data.formatDate(task.dueDate)}</p>
                </div>
            </div>
        `).join('');
    },
    
    getTimeAgo(timestamp) {
        const now = new Date();
        const time = new Date(timestamp);
        const diff = now - time;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        return `${days}d ago`;
    },
    
    refreshActivity() {
        this.loadRecentActivity();
        UI.showAlert('Activity refreshed', 'info');
    },
    
    addQuickTask() {
        const taskTitle = prompt('Enter task title:');
        if (taskTitle) {
            const tasks = Data.load('tasks') || [];
            tasks.push({
                id: Data.generateId(),
                title: taskTitle,
                dueDate: new Date(Date.now() + 86400000).toISOString(),
                completed: false,
                dateCreated: new Date().toISOString()
            });
            Data.save('tasks', tasks);
            this.loadUpcomingTasks();
            UI.showAlert('Task added successfully!');
        }
    },
    
    toggleTask(taskId) {
        const tasks = Data.load('tasks') || [];
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            Data.save('tasks', tasks);
            this.loadUpcomingTasks();
        }
    }
};// Estimates list component for T&J Field Services
const EstimatesList = {
    render() {
        return `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Recent Estimates</h3>
                    <button onclick="EstimatesList.export()" class="text-blue-600 hover:text-blue-800">
                        <i data-lucide="download" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="estimateSearch" placeholder="Search estimates..." 
                           onkeyup="EstimatesList.search()" class="form-input">
                </div>
                
                <div id="estimatesList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="calculator" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Loading estimates...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    load() {
        const container = document.getElementById('estimatesList');
        if (!container) return;
        
        if (Data.estimates.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="calculator" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No estimates yet</p>
                    <p class="text-sm">Create your first estimate above</p>
                </div>
            `;
            return;
        }
        
        const estimates = Data.estimates.slice().reverse(); // Show newest first
        container.innerHTML = estimates.map(estimate => this.renderEstimateCard(estimate)).join('');
        lucide.createIcons();
    },
    
    renderEstimateCard(estimate) {
        const statusColors = {
            pending: 'yellow',
            approved: 'green',
            rejected: 'red',
            expired: 'gray'
        };
        
        const statusColor = statusColors[estimate.status] || 'gray';
        
        return `
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${estimate.customerName}</h4>
                        <p class="text-sm text-gray-600">${estimate.projectType} â€¢ ${estimate.duration || 'Duration TBD'}</p>
                        <p class="text-sm text-gray-500 mt-1">${estimate.description}</p>
                        <div class="flex items-center mt-2">
                            <span class="inline-block w-2 h-2 bg-${statusColor}-400 rounded-full mr-2"></span>
                            <span class="text-sm text-${statusColor}-600 capitalize">${estimate.status}</span>
                            <span class="text-sm text-gray-400 ml-4">${Data.formatDate(estimate.dateCreated)}</span>
                        </div>
                    </div>
                    <div class="text-right ml-4">
                        <div class="text-xl font-bold text-green-600">${Data.formatCurrency(estimate.total)}</div>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="EstimatesList.view('${estimate.id}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button onclick="Estimates.editEstimate('${estimate.id}')" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="EstimatesList.generatePDF('${estimate.id}')" 
                                    class="text-purple-600 hover:text-purple-800 text-sm">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                            </button>
                            <button onclick="Estimates.deleteEstimate('${estimate.id}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },
    
    search() {
        const query = document.getElementById('estimateSearch').value.toLowerCase();
        const filtered = Data.estimates.filter(estimate => 
            estimate.customerName.toLowerCase().includes(query) ||
            estimate.projectType.toLowerCase().includes(query) ||
            estimate.description.toLowerCase().includes(query)
        );
        
        const container = document.getElementById('estimatesList');
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p>No estimates found matching "${query}"</p>
                </div>
            `;
        } else {
            container.innerHTML = filtered.map(estimate => this.renderEstimateCard(estimate)).join('');
            lucide.createIcons();
        }
    },
    
    view(id) {
        const estimate = Data.estimates.find(e => e.id === id);
        if (estimate) {
            UI.showModal(`Estimate Details - ${estimate.customerName}`, `
                <div class="space-y-4">
                    <div><strong>Project:</strong> ${estimate.projectType}</div>
                    <div><strong>Duration:</strong> ${estimate.duration}</div>
                    <div><strong>Description:</strong> ${estimate.description}</div>
                    <div><strong>Total:</strong> ${Data.formatCurrency(estimate.total)}</div>
                    <div><strong>Status:</strong> ${estimate.status}</div>
                    <div><strong>Created:</strong> ${Data.formatDate(estimate.dateCreated)}</div>
                </div>
            `, [
                { text: 'Close', type: 'secondary', onclick: 'this.closest(".fixed").remove()' }
            ]);
        }
    },
    
    generatePDF(id) {
        const estimate = Data.estimates.find(e => e.id === id);
        if (estimate) {
            // Simple PDF generation (you'd want to enhance this)
            UI.showAlert('PDF generation feature coming soon!', 'info');
        }
    },
    
    export() {
        const data = Data.estimates.map(est => ({
            customer: est.customerName,
            project: est.projectType,
            total: est.total,
            status: est.status,
            date: est.dateCreated
        }));
        
        const csv = [
            'Customer,Project,Total,Status,Date',
            ...data.map(row => `${row.customer},${row.project},${row.total},${row.status},${row.date}`)
        ].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'estimates.csv';
        a.click();
        URL.revokeObjectURL(url);
        
        UI.showAlert('Estimates exported successfully!');
    }
};// Customer form component for T&J Field Services
const CustomerForm = {
    render() {
        return `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Add New Customer</h3>
                    <button onclick="Customers.cancelEdit()" id="cancelEdit" class="text-gray-400 hover:text-gray-600 hidden">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="customerForm" onsubmit="Customers.saveCustomer(event)">
                    ${this.renderBasicInfo()}
                    ${this.renderContactInfo()}
                    ${this.renderAddressInfo()}
                    ${this.renderAdditionalInfo()}
                    ${this.renderActions()}
                </form>
            </div>
        `;
    },
    
    renderBasicInfo() {
        return `
            <!-- Basic Information -->
            <div class="mb-6">
                <h4 class="font-medium text-gray-900 mb-3">Basic Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="customerFullName" required class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company (Optional)</label>
                        <input type="text" id="customerCompany" class="form-input">
                    </div>
                </div>
            </div>
        `;
    },
    
    renderContactInfo() {
        return `
            <!-- Contact Information -->
            <div class="mb-6">
                <h4 class="font-medium text-gray-900 mb-3">Contact Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Primary Phone *</label>
                        <input type="tel" id="customerPrimaryPhone" required class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Secondary Phone</label>
                        <input type="tel" id="customerSecondaryPhone" class="form-input">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="customerEmailAddress" class="form-input">
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Contact Method</label>
                    <select id="preferredContact" class="form-select">
                        <option value="phone">Phone</option>
                        <option value="email">Email</option>
                        <option value="text">Text Message</option>
                        <option value="any">Any Method</option>
                    </select>
                </div>
            </div>
        `;
    },
    
    renderAddressInfo() {
        return `
            <!-- Address Information -->
            <div class="mb-6">
                <h4 class="font-medium text-gray-900 mb-3">Address Information</h4>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Street Address</label>
                    <input type="text" id="customerStreetAddress" class="form-input">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                        <input type="text" id="customerCity" class="form-input" value="Delmar">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                        <select id="customerState" class="form-select">
                            <option value="MD" selected>Maryland</option>
                            <option value="DE">Delaware</option>
                            <option value="VA">Virginia</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code</label>
                        <input type="text" id="customerZip" class="form-input" value="21875">
                    </div>
                </div>
            </div>
        `;
    },
    
    renderAdditionalInfo() {
        return `
            <!-- Additional Information -->
            <div class="mb-6">
                <h4 class="font-medium text-gray-900 mb-3">Additional Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer Source</label>
                        <select id="customerSource" class="form-select">
                            <option value="">How did they find us?</option>
                            <option value="referral">Referral</option>
                            <option value="google">Google Search</option>
                            <option value="facebook">Facebook</option>
                            <option value="nextdoor">Nextdoor</option>
                            <option value="yard-sign">Yard Sign</option>
                            <option value="repeat">Repeat Customer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer Type</label>
                        <select id="customerType" class="form-select">
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="property-manager">Property Manager</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="customerNotes" rows="3" class="form-textarea" 
                              placeholder="Any special notes about this customer..."></textarea>
                </div>
            </div>
        `;
    },
    
    renderActions() {
        return `
            <!-- Actions -->
            <div class="flex space-x-4">
                <button type="submit" class="btn-primary flex-1">
                    <i data-lucide="user-plus" class="inline w-4 h-4 mr-2"></i>
                    Add Customer
                </button>
                <button type="button" onclick="CustomerForm.clear()" class="btn-secondary">
                    Clear
                </button>
            </div>
        `;
    },
    
    collectData() {
        return {
            name: document.getElementById('customerFullName').value,
            company: document.getElementById('customerCompany').value,
            primaryPhone: document.getElementById('customerPrimaryPhone').value,
            secondaryPhone: document.getElementById('customerSecondaryPhone').value,
            email: document.getElementById('customerEmailAddress').value,
            preferredContact: document.getElementById('preferredContact').value,
            address: this.getFullAddress(),
            streetAddress: document.getElementById('customerStreetAddress').value,
            city: document.getElementById('customerCity').value,
            state: document.getElementById('customerState').value,
            zip: document.getElementById('customerZip').value,
            source: document.getElementById('customerSource').value,
            type: document.getElementById('customerType').value,
            notes: document.getElementById('customerNotes').value
        };
    },
    
    getFullAddress() {
        const street = document.getElementById('customerStreetAddress').value;
        const city = document.getElementById('customerCity').value;
        const state = document.getElementById('customerState').value;
        const zip = document.getElementById('customerZip').value;
        
        return [street, city, state, zip].filter(part => part.trim()).join(', ');
    },
    
    loadData(customer) {
        document.getElementById('customerFullName').value = customer.name || '';
        document.getElementById('customerCompany').value = customer.company || '';
        document.getElementById('customerPrimaryPhone').value = customer.primaryPhone || '';
        document.getElementById('customerSecondaryPhone').value = customer.secondaryPhone || '';
        document.getElementById('customerEmailAddress').value = customer.email || '';
        document.getElementById('preferredContact').value = customer.preferredContact || 'phone';
        document.getElementById('customerStreetAddress').value = customer.streetAddress || '';
        document.getElementById('customerCity').value = customer.city || 'Delmar';
        document.getElementById('customerState').value = customer.state || 'MD';
        document.getElementById('customerZip').value = customer.zip || '21875';
        document.getElementById('customerSource').value = customer.source || '';
        document.getElementById('customerType').value = customer.type || 'residential';
        document.getElementById('customerNotes').value = customer.notes || '';
        
        // Show cancel button
        document.getElementById('cancelEdit').classList.remove('hidden');
    },
    
    clear() {
        UI.clearForm(document.getElementById('customerForm'));
        
        // Reset defaults
        document.getElementById('customerCity').value = 'Delmar';
        document.getElementById('customerState').value = 'MD';
        document.getElementById('customerZip').value = '21875';
        document.getElementById('preferredContact').value = 'phone';
        document.getElementById('customerType').value = 'residential';
        
        // Hide cancel button
        document.getElementById('cancelEdit').classList.add('hidden');
    }
};// Customers export component for T&J Field Services
const CustomersExport = {
    export() {
        const data = Data.customers.map(customer => ({
            name: customer.name,
            company: customer.company || '',
            phone: customer.primaryPhone,
            email: customer.email || '',
            address: customer.address || '',
            type: customer.type || 'residential',
            dateAdded: customer.dateAdded
        }));
        
        const csv = [
            'Name,Company,Phone,Email,Address,Type,Date Added',
            ...data.map(row => `"${row.name}","${row.company}","${row.phone}","${row.email}","${row.address}","${row.type}","${row.dateAdded}"`)
        ].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'customers.csv';
        a.click();
        URL.revokeObjectURL(url);
        
        UI.showAlert('Customers exported successfully!');
    },
    
    exportToVCF(id) {
        const customer = Data.customers.find(c => c.id === id);
        if (customer) {
            const vcf = [
                'BEGIN:VCARD',
                'VERSION:3.0',
                `FN:${customer.name}`,
                `TEL:${customer.primaryPhone}`,
                customer.email ? `EMAIL:${customer.email}` : '',
                customer.address ? `ADR:;;${customer.address};;;` : '',
                'END:VCARD'
            ].filter(line => line).join('\n');
            
            const blob = new Blob([vcf], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${customer.name.replace(/\s+/g, '_')}.vcf`;
            a.click();
            URL.revokeObjectURL(url);
            
            UI.showAlert('Contact exported to VCF!');
        }
    }
};// Projects filter component for T&J Field Services
const ProjectsFilter = {
    render() {
        return `
            <!-- Search and Filters -->
            <div class="mb-4 space-y-3">
                <input type="text" id="projectSearch" placeholder="Search projects..." 
                       onkeyup="ProjectsList.search()" class="form-input">
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="ProjectsList.filter('all')" 
                            class="filter-btn active" data-filter="all">All</button>
                    <button onclick="ProjectsList.filter('active')" 
                            class="filter-btn" data-filter="active">Active</button>
                    <button onclick="ProjectsList.filter('pending')" 
                            class="filter-btn" data-filter="pending">Pending</button>
                    <button onclick="ProjectsList.filter('completed')" 
                            class="filter-btn" data-filter="completed">Completed</button>
                    <button onclick="ProjectsList.filter('high-priority')" 
                            class="filter-btn" data-filter="high-priority">High Priority</button>
                </div>
            </div>
        `;
    }
};// Projects export component for T&J Field Services
const ProjectsExport = {
    export() {
        const data = Data.projects.map(project => ({
            name: project.name,
            customer: project.customerName,
            type: project.type,
            status: project.status,
            priority: project.priority,
            value: project.value || 0,
            startDate: project.startDate || '',
            endDate: project.endDate || '',
            duration: project.duration || '',
            address: project.address || '',
            dateCreated: project.dateCreated
        }));
        
        const csv = [
            'Project Name,Customer,Type,Status,Priority,Value,Start Date,End Date,Duration,Address,Date Created',
            ...data.map(row => `"${row.name}","${row.customer}","${row.type}","${row.status}","${row.priority}","${row.value}","${row.startDate}","${row.endDate}","${row.duration}","${row.address}","${row.dateCreated}"`)
        ].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'projects.csv';
        a.click();
        URL.revokeObjectURL(url);
        
        UI.showAlert('Projects exported successfully!');
    },
    
    exportByStatus(status) {
        const filteredProjects = Data.projects.filter(p => p.status === status);
        
        if (filteredProjects.length === 0) {
            UI.showAlert(`No ${status} projects to export`, 'info');
            return;
        }
        
        const data = filteredProjects.map(project => ({
            name: project.name,
            customer: project.customerName,
            type: project.type,
            value: project.value || 0,
            startDate: project.startDate || '',
            endDate: project.endDate || '',
            dateCreated: project.dateCreated
        }));
        
        const csv = [
            'Project Name,Customer,Type,Value,Start Date,End Date,Date Created',
            ...data.map(row => `"${row.name}","${row.customer}","${row.type}","${row.value}","${row.startDate}","${row.endDate}","${row.dateCreated}"`)
        ].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${status}_projects.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        UI.showAlert(`${status} projects exported successfully!`);
    },
    
    exportProjectSummary() {
        const summary = {
            totalProjects: Data.projects.length,
            activeProjects: Data.projects.filter(p => p.status === 'in-progress').length,
            completedProjects: Data.projects.filter(p => p.status === 'completed').length,
            pendingProjects: Data.projects.filter(p => p.status === 'pending').length,
            totalValue: Data.projects.reduce((sum, p) => sum + (p.value || 0), 0),
            averageValue: Data.projects.length > 0 ? 
                (Data.projects.reduce((sum, p) => sum + (p.value || 0), 0) / Data.projects.length) : 0
        };
        
        const summaryText = [
            'T&J FIELD SERVICES - PROJECT SUMMARY',
            '=====================================',
            '',
            `Total Projects: ${summary.totalProjects}`,
            `Active Projects: ${summary.activeProjects}`,
            `Completed Projects: ${summary.completedProjects}`,
            `Pending Projects: ${summary.pendingProjects}`,
            '',
            `Total Project Value: ${Data.formatCurrency(summary.totalValue)}`,
            `Average Project Value: ${Data.formatCurrency(summary.averageValue)}`,
            '',
            `Report Generated: ${new Date().toLocaleDateString()}`,
            '',
            'PROJECT BREAKDOWN BY TYPE:',
            '-------------------------'
        ];
        
        // Add project type breakdown
        const typeBreakdown = {};
        Data.projects.forEach(project => {
            typeBreakdown[project.type] = (typeBreakdown[project.type] || 0) + 1;
        });
        
        Object.entries(typeBreakdown).forEach(([type, count]) => {
            summaryText.push(`${type}: ${count} projects`);
        });
        
        const blob = new Blob([summaryText.join('\n')], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'project_summary.txt';
        a.click();
        URL.revokeObjectURL(url);
        
        UI.showAlert('Project summary exported!');
    }
};// Calendar sidebar component for T&J Field Services
const CalendarSidebar = {
    render() {
        return `
            <!-- Quick Add Event -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h4 class="font-semibold mb-3">Quick Add Event</h4>
                ${EventForm.renderQuick()}
            </div>
            
            <!-- Today's Schedule -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h4 class="font-semibold mb-3">Today's Schedule</h4>
                <div id="todaySchedule">
                    <div class="text-center text-gray-500 py-4">
                        <i data-lucide="calendar-x" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                        <p class="text-sm">No events today</p>
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Events -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h4 class="font-semibold mb-3">Upcoming Events</h4>
                <div id="upcomingEvents">
                    <div class="text-center text-gray-500 py-4">
                        <i data-lucide="clock" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                        <p class="text-sm">Loading...</p>
                    </div>
                </div>
            </div>
            
            <!-- Project Deadlines -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h4 class="font-semibold mb-3">Project Deadlines</h4>
                <div id="projectDeadlines">
                    <div class="text-center text-gray-500 py-4">
                        <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                        <p class="text-sm">Loading...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    loadUpcoming() {
        const container = document.getElementById('upcomingEvents');
        if (!container) return;
        
        Data.events = Data.events || [];
        
        const today = new Date();
        const upcoming = Data.events
            .filter(event => new Date(event.start) > today)
            .sort((a, b) => new Date(a.start) - new Date(b.start))
            .slice(0, 5);
        
        if (upcoming.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <i data-lucide="calendar-x" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                    <p class="text-sm">No upcoming events</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = upcoming.map(event => this.renderEventItem(event)).join('');
        
        // Load today's schedule
        this.loadTodaySchedule();
        
        // Load project deadlines
        this.loadProjectDeadlines();
    },
    
    loadTodaySchedule() {
        const container = document.getElementById('todaySchedule');
        if (!container) return;
        
        const today = new Date().toDateString();
        const todayEvents = Data.events.filter(event => 
            new Date(event.start).toDateString() === today
        ).sort((a, b) => new Date(a.start) - new Date(b.start));
        
        if (todayEvents.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <i data-lucide="calendar-x" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                    <p class="text-sm">No events today</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = todayEvents.map(event => this.renderEventItem(event, true)).join('');
    },
    
    loadDayEvents(dateStr) {
        const container = document.getElementById('todaySchedule');
        if (!container) return;
        
        const selectedDate = new Date(dateStr).toDateString();
        const dayEvents = Data.events.filter(event => 
            new Date(event.start).toDateString() === selectedDate
        ).sort((a, b) => new Date(a.start) - new Date(b.start));
        
        // Update header
        const header = container.parentElement.querySelector('h4');
        if (header) {
            const dateObj = new Date(dateStr);
            header.textContent = `${dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'short', 
                day: 'numeric' 
            })} Schedule`;
        }
        
        if (dayEvents.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <i data-lucide="calendar-x" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                    <p class="text-sm">No events this day</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = dayEvents.map(event => this.renderEventItem(event, true)).join('');
    },
    
    loadProjectDeadlines() {
        const container = document.getElementById('projectDeadlines');
        if (!container) return;
        
        const today = new Date();
        const upcoming = Data.projects
            .filter(project => project.endDate && new Date(project.endDate) > today)
            .sort((a, b) => new Date(a.endDate) - new Date(b.endDate))
            .slice(0, 5);
        
        if (upcoming.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                    <p class="text-sm">No upcoming deadlines</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = upcoming.map(project => this.renderDeadlineItem(project)).join('');
    },
    
    renderEventItem(event, showTime = false) {
        const eventDate = new Date(event.start);
        const colors = {
            'appointment': 'blue',
            'project': 'green',
            'estimate': 'orange',
            'personal': 'purple'
        };
        
        const color = colors[event.type] || 'gray';
        
        return `
            <div class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer"
                 onclick="EventActions.viewEvent('${event.id}')">
                <div class="w-3 h-3 bg-${color}-400 rounded-full flex-shrink-0"></div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">${event.title}</div>
                    <div class="text-xs text-gray-500">
                        ${showTime ? eventDate.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit' 
                        }) : eventDate.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        })}
                    </div>
                </div>
            </div>
        `;
    },
    
    renderDeadlineItem(project) {
        const endDate = new Date(project.endDate);
        const today = new Date();
        const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        
        let urgencyColor = 'gray';
        if (daysUntil <= 3) urgencyColor = 'red';
        else if (daysUntil <= 7) urgencyColor = 'orange';
        else if (daysUntil <= 14) urgencyColor = 'yellow';
        
        return `
            <div class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer"
                 onclick="ProjectActions.viewDetails('${project.id}')">
                <div class="w-3 h-3 bg-${urgencyColor}-400 rounded-full flex-shrink-0"></div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">${project.name}</div>
                    <div class="text-xs text-gray-500">
                        Due ${endDate.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        })} (${daysUntil} days)
                    </div>
                </div>
            </div>
        `;
    }
};// Calendar utility functions for T&J Field Services
const CalendarUtils = {
    formatICSDate(date, allDay = false) {
        if (allDay) {
            return date.toISOString().split('T')[0].replace(/-/g, '');
        } else {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }
    },
    
    getPriorityNumber(priority) {
        const priorities = {
            'low': '9',
            'medium': '5', 
            'high': '3',
            'urgent': '1'
        };
        return priorities[priority] || '5';
    },
    
    generateICSContent() {
        let icsContent = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//T&J Field Services//Calendar//EN',
            'CALSCALE:GREGORIAN',
            'METHOD:PUBLISH'
        ];
        
        Data.events.forEach(event => {
            icsContent.push(...this.createICSEvent(event));
        });
        
        icsContent.push('END:VCALENDAR');
        return icsContent.join('\r\n');
    },
    
    createICSEvent(event) {
        const startDate = new Date(event.start);
        const endDate = new Date(event.end);
        
        return [
            'BEGIN:VEVENT',
            `UID:${event.id}@tjfieldservices.com`,
            `DTSTART:${this.formatICSDate(startDate, event.allDay)}`,
            `DTEND:${this.formatICSDate(endDate, event.allDay)}`,
            `SUMMARY:${event.title}`,
            ...(event.description ? [`DESCRIPTION:${event.description.replace(/\n/g, '\\n')}`] : []),
            ...(event.location ? [`LOCATION:${event.location}`] : []),
            `CATEGORIES:${event.type.toUpperCase()}`,
            `PRIORITY:${this.getPriorityNumber(event.priority)}`,
            `CREATED:${this.formatICSDate(new Date(event.dateCreated))}`,
            'END:VEVENT'
        ];
    },
    
    isEventInDateRange(event, startDate, endDate) {
        const eventDate = new Date(event.start);
        return eventDate >= startDate && eventDate <= endDate;
    },
    
    getEventsForDateRange(startDate, endDate) {
        return Data.events.filter(event => 
            this.isEventInDateRange(event, startDate, endDate)
        ).sort((a, b) => new Date(a.start) - new Date(b.start));
    }
};// Event actions component for T&J Field Services
const EventActions = {
    viewEvent(id) {
        const event = Data.events.find(e => e.id === id);
        if (event) {
            const customer = event.customerId ? Data.customers.find(c => c.id === event.customerId) : null;
            const project = event.projectId ? Data.projects.find(p => p.id === event.projectId) : null;
            
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            
            UI.showModal(`Event Details - ${event.title}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><strong>Type:</strong> ${event.type || 'Not specified'}</div>
                        <div><strong>Priority:</strong> ${event.priority || 'Medium'}</div>
                    </div>
                    
                    ${event.description ? `
                        <div><strong>Description:</strong><br>${event.description}</div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><strong>Start:</strong> ${this.formatDateTime(startDate, event.allDay)}</div>
                        <div><strong>End:</strong> ${this.formatDateTime(endDate, event.allDay)}</div>
                    </div>
                    
                    ${event.location ? `
                        <div><strong>Location:</strong><br>${event.location}</div>
                    ` : ''}
                    
                    ${customer ? `
                        <div class="border-t pt-4">
                            <h4 class="font-semibold mb-2">Customer Information</h4>
                            <div><strong>Name:</strong> ${customer.name}</div>
                            <div><strong>Phone:</strong> <a href="tel:${customer.primaryPhone}" class="text-blue-600">${customer.primaryPhone}</a></div>
                            ${customer.email ? `<div><strong>Email:</strong> <a href="mailto:${customer.email}" class="text-blue-600">${customer.email}</a></div>` : ''}
                        </div>
                    ` : ''}
                    
                    ${project ? `
                        <div class="border-t pt-4">
                            <h4 class="font-semibold mb-2">Related Project</h4>
                            <div><strong>Project:</strong> ${project.name}</div>
                            <div><strong>Status:</strong> ${project.status}</div>
                            <div><strong>Value:</strong> ${Data.formatCurrency(project.value || 0)}</div>
                        </div>
                    ` : ''}
                    
                    ${this.renderReminders(event)}
                    
                    <div class="text-sm text-gray-500 border-t pt-4">
                        Created: ${Data.formatDate(event.dateCreated)}
                    </div>
                </div>
            `, [
                { text: 'Edit Event', type: 'primary', onclick: `EventActions.editEvent('${event.id}'); this.closest('.fixed').remove();` },
                { text: 'Delete Event', type: 'danger', onclick: `EventActions.deleteEvent('${event.id}'); this.closest('.fixed').remove();` },
                { text: 'Close', type: 'secondary', onclick: 'this.closest(".fixed").remove()' }
            ]);
        }
    },
    
    editEvent(id) {
        const event = Data.events.find(e => e.id === id);
        if (event) {
            UI.showModal('Edit Event', EventForm.renderFull(), [
                { text: 'Update Event', type: 'primary', onclick: 'EventForm.saveFullEvent()' },
                { text: 'Cancel', type: 'secondary', onclick: 'this.closest(".fixed").remove()' }
            ]);
            
            // Load event data into form
            setTimeout(() => {
                EventForm.loadEventData(event);
            }, 100);
        }
    },
    
    deleteEvent(id) {
        const event = Data.events.find(e => e.id === id);
        if (event && confirm(`Are you sure you want to delete "${event.title}"?`)) {
            if (Calendar.deleteEvent(id)) {
                UI.showAlert('Event deleted successfully!');
            }
        }
    },
    
    markComplete(id) {
        const event = Data.events.find(e => e.id === id);
        if (event) {
            event.completed = true;
            event.completedDate = new Date().toISOString();
            Data.save('events', Data.events);
            
            CalendarView.load();
            CalendarSidebar.loadUpcoming();
            UI.showAlert('Event marked as completed!');
        }
    },
    
    reschedule(id) {
        const event = Data.events.find(e => e.id === id);
        if (event) {
            UI.showModal(`Reschedule - ${event.title}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Date</label>
                            <input type="date" id="rescheduleDate" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Time</label>
                            <input type="time" id="rescheduleTime" class="form-input" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Reschedule</label>
                        <textarea id="rescheduleReason" rows="3" class="form-textarea" 
                                  placeholder="Optional reason for rescheduling..."></textarea>
                    </div>
                </div>
            `, [
                { text: 'Reschedule', type: 'primary', onclick: `EventActions.saveReschedule('${id}')` },
                { text: 'Cancel', type: 'secondary', onclick: 'this.closest(".fixed").remove()' }
            ]);
            
            // Set current values
            const currentDate = new Date(event.start);
            document.getElementById('rescheduleDate').value = currentDate.toISOString().split('T')[0];
            document.getElementById('rescheduleTime').value = currentDate.toTimeString().slice(0, 5);
        }
    },
    
    saveReschedule(id) {
        const newDate = document.getElementById('rescheduleDate').value;
        const newTime = document.getElementById('rescheduleTime').value;
        const reason = document.getElementById('rescheduleReason').value;
        
        if (!newDate || !newTime) {
            UI.showAlert('Please select a new date and time', 'error');
            return;
        }
        
        const event = Data.events.find(e => e.id === id);
        if (event) {
            const oldStart = new Date(event.start);
            const duration = new Date(event.end) - oldStart;
            
            event.start = `${newDate}T${newTime}`;
            event.end = new Date(new Date(event.start).getTime() + duration).toISOString();
            
            if (reason) {
                event.rescheduleHistory = event.rescheduleHistory || [];
                event.rescheduleHistory.push({
                    oldDate: oldStart.toISOString(),
                    newDate: event.start,
                    reason: reason,
                    date: new Date().toISOString()
                });
            }
            
            Data.save('events', Data.events);
            
            CalendarView.load();
            CalendarSidebar.loadUpcoming();
            UI.showAlert('Event rescheduled successfully!');
            
            document.querySelector('.fixed').remove();
        }
    },
    
    duplicate(id) {
        const event = Data.events.find(e => e.id === id);
        if (event) {
            const duplicatedEvent = {
                ...event,
                id: Date.now().toString(),
                title: `${event.title} (Copy)`,
                dateCreated: new Date().toISOString()
            };
            
            delete duplicatedEvent.completed;
            delete duplicatedEvent.completedDate;
            
            Calendar.addEvent(duplicatedEvent);
            UI.showAlert('Event duplicated successfully!');
        }
    },
    
    createRecurring(id) {
        const event = Data.events.find(e => e.id === id);
        if (event) {
            UI.showModal(`Create Recurring Event - ${event.title}`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Repeat</label>
                        <select id="recurringType" class="form-select">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Number of Occurrences</label>
                        <input type="number" id="recurringCount" min="1" max="52" value="4" class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date (Optional)</label>
                        <input type="date" id="recurringEndDate" class="form-input">
                    </div>
                </div>
            `, [
                { text: 'Create Series', type: 'primary', onclick: `EventActions.saveRecurring('${id}')` },
                { text: 'Cancel', type: 'secondary', onclick: 'this.closest(".fixed").remove()' }
            ]);
        }
    },
    
    saveRecurring(id) {
        const event = Data.events.find(e => e.id === id);
        const type = document.getElementById('recurringType').value;
        const count = parseInt(document.getElementById('recurringCount').value);
        const endDate = document.getElementById('recurringEndDate').value;
        
        if (event && count > 0) {
            const startDate = new Date(event.start);
            const duration = new Date(event.end) - startDate;
            
            for (let i = 1; i <= count; i++) {
                let nextDate = new Date(startDate);
                
                switch(type) {
                    case 'daily':
                        nextDate.setDate(nextDate.getDate() + i);
                        break;
                    case 'weekly':
                        nextDate.setDate(nextDate.getDate() + (i * 7));
                        break;
                    case 'monthly':
                        nextDate.setMonth(nextDate.getMonth() + i);
                        break;
                }
                
                if (endDate && nextDate > new Date(endDate)) break;
                
                const recurringEvent = {
                    ...event,
                    id: `${event.id}_${i}`,
                    start: nextDate.toISOString(),
                    end: new Date(nextDate.getTime() + duration).toISOString(),
                    title: `${event.title} (${i + 1})`,
                    dateCreated: new Date().toISOString(),
                    parentEventId: event.id
                };
                
                Calendar.addEvent(recurringEvent);
            }
            
            UI.showAlert(`Created ${count} recurring events!`);
            document.querySelector('.fixed').remove();
        }
    },
    
    formatDateTime(date, allDay) {
        if (allDay) {
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        } else {
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }
    },
    
    renderReminders(event) {
        if (!event.emailReminder && !event.smsReminder) return '';
        
        return `
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-2">Reminders</h4>
                ${event.emailReminder ? `<div>Email: ${event.emailReminder} minutes before</div>` : ''}
                ${event.smsReminder ? `<div>SMS: ${event.smsReminder} minutes before</div>` : ''}
            </div>
        `;
    }
};
};