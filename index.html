// Navigation component for T&J Field Services
const Navigation = {
    items: [
        { id: 'dashboard', label: 'Dashboard', icon: 'home' },
        { id: 'estimates', label: 'Estimates', icon: 'calculator' },
        { id: 'customers', label: 'Customers', icon: 'users' },
        { id: 'projects', label: 'Projects', icon: 'briefcase' },
        { id: 'inventory', label: 'Inventory', icon: 'package' },
        { id: 'schedule', label: 'Schedule', icon: 'calendar' },
        { id: 'reports', label: 'Reports', icon: 'bar-chart' }
    ],
    
    render() {
        const navElement = document.getElementById('navigation');
        navElement.innerHTML = `
            <nav class="bg-white shadow-md">
                <div class="container mx-auto px-4">
                    <div class="flex space-x-8 overflow-x-auto">
                        ${this.items.map(item => `
                            <button 
                                onclick="navigateTo('${item.id}')" 
                                class="nav-link px-4 py-3 text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 whitespace-nowrap"
                                data-page="${item.id}"
                            >
                                <i data-lucide="${item.icon}" class="inline w-4 h-4 mr-2"></i>
                                ${item.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </nav>
        `;
    },
    
    setActive(pageId) {
        // Remove active class from all nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Add active class to current page
        const activeLink = document.querySelector(`[data-page="${pageId}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }// Dashboard page for T&J Field Services
const Dashboard = {
    render() {
        const content = document.getElementById('content');
        content.innerHTML = `
            <div class="fade-in">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Business Dashboard</h2>
                
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    ${this.renderMetricCard('estimates', 'Total Estimates', 'file-text', 'blue')}
                    ${this.renderMetricCard('customers', 'Active Customers', 'users', 'green')}
                    ${this.renderMetricCard('projects', 'Active Projects', 'briefcase', 'orange')}
                    ${this.renderMetricCard('revenue', 'Monthly Revenue', 'dollar-sign', 'purple')}
                </div>

                <!-- Quick Actions -->
                ${this.renderQuickActions()}

                <!-- Recent Activity & Tasks -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    ${this.renderRecentActivity()}
                    ${this.renderUpcomingTasks()}
                </div>

                <!-- Quick Stats -->
                ${this.renderQuickStats()}
            </div>
        `;
        
        this.updateMetrics();
        this.loadRecentActivity();
        this.loadUpcomingTasks();
    },
    
    renderMetricCard(type, title, icon, color) {
        return `
            <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <i data-lucide="${icon}" class="w-8 h-8 text-${color}-600 mr-3"></i>
                    <div>
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <p class="text-2xl font-bold text-${color}-600" id="${type}Count">0</p>
                        <p class="text-sm text-gray-500" id="${type}Detail">Loading...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    renderQuickActions() {
        const actions = [
            { id: 'estimates', title: 'New Estimate', subtitle: 'Create project estimate', icon: 'calculator', color: 'blue' },
            { id: 'customers', title: 'Add Customer', subtitle: 'New customer record', icon: 'user-plus', color: 'green' },
            { id: 'projects', title: 'New Project', subtitle: 'Start new project', icon: 'plus-circle', color: 'orange' },
            { id: 'schedule', title: 'Schedule Job', subtitle: 'Book appointment', icon: 'calendar-plus', color: 'purple' }
        ];
        
        return `
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    ${actions.map(action => `
                        <button onclick="navigateTo('${action.id}')" class="bg-${action.color}-600 text-white p-4 rounded-lg hover:bg-${action.color}-700 transition-colors template-btn">
                            <i data-lucide="${action.icon}" class="w-6 h-6 mx-auto mb-2"></i>
                            <div class="font-semibold">${action.title}</div>
                            <div class="text-sm opacity-80">${action.subtitle}</div>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    },
    
    renderRecentActivity() {
        return `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Recent Activity</h3>
                    <button onclick="Dashboard.refreshActivity()" class="text-blue-600 hover:text-blue-800">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="recentActivity" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="activity" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    renderUpcomingTasks() {
        return `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Upcoming Tasks</h3>
                    <button onclick="Dashboard.addQuickTask()" class="text-blue-600 hover:text-blue-800">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="upcomingTasks" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="check-square" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Loading tasks...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    renderQuickStats() {
        return `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="avgEstimate">$0</div>
                    <div class="text-sm text-blue-800">Avg Estimate</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="conversionRate">0%</div>
                    <div class="text-sm text-green-800">Conversion Rate</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-orange-600" id="avgDays">0</div>
                    <div class="text-sm text-orange-800">Avg Project Days</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600">98%</div>
                    <div class="text-sm text-purple-800">Customer Rating</div>
                </div>
            </div>
        `;
    },
    
    updateMetrics() {
        // Update estimates
        const estimatesCount = document.getElementById('estimatesCount');
        const estimatesDetail = document.getElementById('estimatesDetail');
        if (estimatesCount) {
            estimatesCount.textContent = Data.estimates.length;
            const totalValue = Data.estimates.reduce((sum, est) => sum + (parseFloat(est.total) || 0), 0);
            estimatesDetail.textContent = Data.formatCurrency(totalValue) + ' total value';
        }
        
        // Update customers
        const customersCount = document.getElementById('customersCount');
        const customersDetail = document.getElementById('customersDetail');
        if (customersCount) {
            customersCount.textContent = Data.customers.length;
            customersDetail.textContent = 'Active customers';
        }
        
        // Update projects
        const projectsCount = document.getElementById('projectsCount');
        const projectsDetail = document.getElementById('projectsDetail');
        if (projectsCount) {
            const activeProjects = Data.projects.filter(p => p.status === 'in-progress');
            projectsCount.textContent = activeProjects.length;
            projectsDetail.textContent = 'In progress';
        }
        
        // Update revenue
        const revenueCount = document.getElementById('revenueCount');
        const revenueDetail = document.getElementById('revenueDetail');
        if (revenueCount) {
            const completedProjects = Data.projects.filter(p => p.status === 'completed');
            const revenue = completedProjects.reduce((sum, proj) => sum + (parseFloat(proj.value) || 0), 0);
            revenueCount.textContent = Data.formatCurrency(revenue);
            revenueDetail.textContent = 'Total completed';
        }
        
        // Update quick stats
        this.updateQuickStats();
    },
    
    updateQuickStats() {
        // Average estimate
        const avgEstimate = document.getElementById('avgEstimate');
        if (avgEstimate && Data.estimates.length > 0) {
            const avg = Data.estimates.reduce((sum, est) => sum + (parseFloat(est.total) || 0), 0) / Data.estimates.length;
            avgEstimate.textContent = Data.formatCurrency(avg);
        }
        
        // Conversion rate
        const conversionRate = document.getElementById('conversionRate');
        if (conversionRate && Data.estimates.length > 0) {
            const approved = Data.estimates.filter(est => est.status === 'approved').length;
            const rate = (approved / Data.estimates.length * 100).toFixed(1);
            conversionRate.textContent = rate + '%';
        }
    },
    
    loadRecentActivity() {
        const container = document.getElementById('recentActivity');
        if (!container) return;
        
        const activities = [];
        
        // Recent estimates
        Data.estimates.slice(-3).forEach(est => {
            activities.push({
                title: `New estimate for ${est.customerName}`,
                subtitle: Data.formatCurrency(est.total),
                time: est.dateCreated,
                icon: 'calculator',
                color: 'blue'
            });
        });
        
        // Recent customers
        Data.customers.slice(-2).forEach(customer => {
            activities.push({
                title: `New customer: ${customer.name}`,
                subtitle: customer.phone,
                time: customer.dateAdded,
                icon: 'user-plus',
                color: 'green'
            });
        });
        
        activities.sort((a, b) => new Date(b.time) - new Date(a.time));
        
        if (activities.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="activity" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No recent activity</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = activities.slice(0, 5).map(activity => `
            <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition-colors">
                <div class="w-8 h-8 bg-${activity.color}-100 rounded-full flex items-center justify-center mr-3">
                    <i data-lucide="${activity.icon}" class="w-4 h-4 text-${activity.color}-600"></i>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">${activity.title}</p>
                    <p class="text-xs text-gray-500">${activity.subtitle}</p>
                </div>
                <div class="text-xs text-gray-400">
                    ${this.getTimeAgo(activity.time)}
                </div>
            </div>
        `).join('');
    },
    
    loadUpcomingTasks() {
        const container = document.getElementById('upcomingTasks');
        if (!container) return;
        
        const tasks = Data.load('tasks') || [];
        
        if (tasks.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="check-square" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No upcoming tasks</p>
                    <button onclick="Dashboard.addQuickTask()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">
                        Add a task
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = tasks.slice(0, 5).map(task => `
            <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition-colors">
                <input type="checkbox" ${task.completed ? 'checked' : ''} 
                       onchange="Dashboard.toggleTask('${task.id}')" 
                       class="mr-3">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900 ${task.completed ? 'line-through' : ''}">${task.title}</p>
                    <p class="text-xs text-gray-500">${Data.formatDate(task.dueDate)}</p>
                </div>
            </div>
        `).join('');
    },
    
    getTimeAgo(timestamp) {
        const now = new Date();
        const time = new Date(timestamp);
        const diff = now - time;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        return `${days}d ago`;
    },
    
    refreshActivity() {
        this.loadRecentActivity();
        UI.showAlert('Activity refreshed', 'info');
    },
    
    addQuickTask() {
        const taskTitle = prompt('Enter task title:');
        if (taskTitle) {
            const tasks = Data.load('tasks') || [];
            tasks.push({
                id: Data.generateId(),
                title: taskTitle,
                dueDate: new Date(Date.now() + 86400000).toISOString(),
                completed: false,
                dateCreated: new Date().toISOString()
            });
            Data.save('tasks', tasks);
            this.loadUpcomingTasks();
            UI.showAlert('Task added successfully!');
        }
    },
    
    toggleTask(taskId) {
        const tasks = Data.load('tasks') || [];
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            Data.save('tasks', tasks);
            this.loadUpcomingTasks();
        }
    }
};// Estimates list component for T&J Field Services
const EstimatesList = {
    render() {
        return `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Recent Estimates</h3>
                    <button onclick="EstimatesList.export()" class="text-blue-600 hover:text-blue-800">
                        <i data-lucide="download" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="estimateSearch" placeholder="Search estimates..." 
                           onkeyup="EstimatesList.search()" class="form-input">
                </div>
                
                <div id="estimatesList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="calculator" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Loading estimates...</p>
                    </div>
                </div>
            </div>
        `;
    },
    
    load() {
        const container = document.getElementById('estimatesList');
        if (!container) return;
        
        if (Data.estimates.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="calculator" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No estimates yet</p>
                    <p class="text-sm">Create your first estimate above</p>
                </div>
            `;
            return;
        }
        
        const estimates = Data.estimates.slice().reverse(); // Show newest first
        container.innerHTML = estimates.map(estimate => this.renderEstimateCard(estimate)).join('');
        lucide.createIcons();
    },
    
    renderEstimateCard(estimate) {
        const statusColors = {
            pending: 'yellow',
            approved: 'green',
            rejected: 'red',
            expired: 'gray'
        };
        
        const statusColor = statusColors[estimate.status] || 'gray';
        
        return `
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${estimate.customerName}</h4>
                        <p class="text-sm text-gray-600">${estimate.projectType} • ${estimate.duration || 'Duration TBD'}</p>
                        <p class="text-sm text-gray-500 mt-1">${estimate.description}</p>
                        <div class="flex items-center mt-2">
                            <span class="inline-block w-2 h-2 bg-${statusColor}-400 rounded-full mr-2"></span>
                            <span class="text-sm text-${statusColor}-600 capitalize">${estimate.status}</span>
                            <span class="text-sm text-gray-400 ml-4">${Data.formatDate(estimate.dateCreated)}</span>
                        </div>
                    </div>
                    <div class="text-right ml-4">
                        <div class="text-xl font-bold text-green-600">${Data.formatCurrency(estimate.total)}</div>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="EstimatesList.view('${estimate.id}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button onclick="Estimates.editEstimate('${estimate.id}')" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="EstimatesList.generatePDF('${estimate.id}')" 
                                    class="text-purple-600 hover:text-purple-800 text-sm">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                            </button>
                            <button onclick="Estimates.deleteEstimate('${estimate.id}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },
    
    search() {
        const query = document.getElementById('estimateSearch').value.toLowerCase();
        const filtered = Data.estimates.filter(estimate => 
            estimate.customerName.toLowerCase().includes(query) ||
            estimate.projectType.toLowerCase().includes(query) ||
            estimate.description.toLowerCase().includes(query)
        );
        
        const container = document.getElementById('estimatesList');
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p>No estimates found matching "${query}"</p>
                </div>
            `;
        } else {
            container.innerHTML = filtered.map(estimate => this.renderEstimateCard(estimate)).join('');
            lucide.createIcons();
        }
    },
    
    view(id) {
        const estimate = Data.estimates.find(e => e.id === id);
        if (estimate) {
            UI.showModal(`Estimate Details - ${estimate.customerName}`, `
                <div class="space-y-4">
                    <div><strong>Project:</strong> ${estimate.projectType}</div>
                    <div><strong>Duration:</strong> ${estimate.duration}</div>
                    <div><strong>Description:</strong> ${estimate.description}</div>
                    <div><strong>Total:</strong> ${Data.formatCurrency(estimate.total)}</div>
                    <div><strong>Status:</strong> ${estimate.status}</div>
                    <div><strong>Created:</strong> ${Data.formatDate(estimate.dateCreated)}</div>
                </div>
            `, [
                { text: 'Close', type: 'secondary', onclick: 'this.closest(".fixed").remove()' }
            ]);
        }
    },
    
    generatePDF(id) {
        const estimate = Data.estimates.find(e => e.id === id);
        if (estimate) {
            // Simple PDF generation (you'd want to enhance this)
            UI.showAlert('PDF generation feature coming soon!', 'info');
        }
    },
    
    export() {
        const data = Data.estimates.map(est => ({
            customer: est.customerName,
            project: est.projectType,
            total: est.total,
            status: est.status,
            date: est.dateCreated
        }));
        
        const csv = [
            'Customer,Project,Total,Status,Date',
            ...data.map(row => `${row.customer},${row.project},${row.total},${row.status},${row.date}`)
        ].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'estimates.csv';
        a.click();
        URL.revokeObjectURL(url);
        
        UI.showAlert('Estimates exported successfully!');
    }
};
};